{# NLU LANDING PAGE #}
{# This is the first page that the non-logged-in user sees #}
{# Authentication is handled in views.index #}

{% extends 'base.html' %}

{% block header %}
{% endblock %}

{# Funnel NLU to Registration system #}

{% block content %}
  {% if not user.is_authenticated %}
    {# User is not authenticated #}
      {# Show registration page #}

    {% if form.errors %}
      <p class="errors">Please correct the errors below: {{ form.non_field_errors }}</p>
    {% endif %}

      
    {# Value Proposition Line #} 
    <div id="headline" class="lead">A New Way to Share Experiences</div>

    <h1>Create an account</h1>

    {# For invited users #}
    {% if invitation_key %}
      <h2>
          <div>{{ invitee_object.from_user }} invited you to share in the experience: "{{ invitee_object.from_user_album }}"</div>
      </h2>
    {% endif %}
    
    <form method="post" action="" id="registrationForm" class="wide">
    {% csrf_token %}

      <p>
        <!--<label for="id_username">Full Name:</label>-->
        {% if form.username.errors %}
          <p class="errors">{{ form.username.errors.as_text }}</p>
        {% endif %}
        <div class="control-group">
          <div class="controls">
            {{ form.username }}
          </div>
        </div>
      </p>

      {# Use prefilled email for registration #}
      {% if not invitee_object.to_user_email %}
        <p>
          <!--<label for="id_email">Email:</label>-->
          {% if form.email.errors %}
            <p class="errors">{{ form.email.errors.as_text }}</p>
          {% endif %}
          <div class="control-group">
            <div class="controls">
              {{ form.email }}
            </div>
          </div>
        </p>
      {% else %}
        <label for="id_email" class="text-success">{{ invitee_object.to_user_email }} </label>
        {% if form.email.errors %}
          <p class="errors">{{ form.email.errors.as_text }}</p>
        {% endif %}
      {% endif %}
      {# end #}

      <p>
        <!--<label for="id_password1">Password:</label>-->
        {% if form.password1.errors %}
          <p class="errors">{{ form.password1.errors.as_text }}</p>
        {% endif %}
          
          <div class="control-group">
            <div class="controls">
              {{ form.password1 }}
            </div>
          </div>
      </p>
      {% comment %}
      <p>
        <label for="id_password2">Password (type again to catch typos):</label>
        {% if form.password2.errors %}
          <p class="errors">{{ form.password2.errors.as_text }}</p>
        {% endif %}
        {{ form.password2 }}
      </p>
      {% endcomment %}
      <p class="submit"><input type="submit" class="btn btn-primary" value="Register &rarr;"></p>
    </form>



    <div>
      {% include 'registration/login_landing.html' %}
    </div>

    {% comment %}
    <h1>Log in</h1>

      {% if form.errors %}
      <p class="error">Please correct the errors below:</p>
      {% endif %}

      <form method="post" action="?next={{ next|default:"/" }}">{% csrf_token %}
      <dl>
        {# Change to Email Later #}
        {# Also add Closed Alpha email regex #}
      <dt><label for="id_username">Full Name:</label>{% if form.username.errors %} <span class="error">{{ form.username.errors|join:", " }}</span>{% endif %}</dt>
        <dd>{{ form.username }}</dd>
      <dt><label for="id_password">Password:</label>{% if form.password.errors %} <span class="error">{{ form.password.errors|join:", " }}</span>{% endif %}</dt>
        <dd>{{ form.password }}</dd>
      <dt><input type="submit" value="Log in" /></dt>
      </dl>
      </form>
    {% endcomment %}
    
    {# Video for NLU to watch #}
      <div id="video_container">
        <div id="video">
          <iframe src="http://player.vimeo.com/video/47618336?byline=0&amp;portrait=0" width="500" height="281" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
        </div>
      </div>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script type="text/javascript" src="{{ STATIC_URL}}js/jquery.validate.js"></script>
  <script>
  // csrf passed for AJAX 
  $.ajaxSetup({ 
       beforeSend: function(xhr, settings) {
           function getCookie(name) {
               var cookieValue = null;
               if (document.cookie && document.cookie != '') {
                   var cookies = document.cookie.split(';');
                   for (var i = 0; i < cookies.length; i++) {
                       var cookie = jQuery.trim(cookies[i]);
                       // Does this cookie string begin with the name we want?
                   if (cookie.substring(0, name.length + 1) == (name + '=')) {
                       cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                       break;
                   }
               }
           }
           return cookieValue;
           }
           if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
               // Only send the token to relative URLs i.e. locally.
               xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
           }
       } 
  });
    $.validator.addMethod("usernameRegex", function(value, element){
      return this.optional(element) || /^[A-Za-z0-9._%-]+\s[A-Za-z0-9._%-]+$/i.test(value);
    }, "Please enter your full name");

    $.validator.addMethod("emailRegex", function(value, element){
      return this.optional(element) || /^[A-Za-z0-9._%-]+@(dartmouth|berkeley|nyu)\.edu$/i.test(value);
    }, "Please enter a Berkeley, Dartmouth or NYU email");

    $('#registrationForm').validate({
      rules: {
        "username": {
          required: true,
          usernameRegex: true,
        },
        "email": {
          emailRegex: true,
          remote: {
            url: "/validate/email_duplicates/",
            type: "post",
            data: { 
              response: function(){
                return $('#email').val();
              }
            }
          }
        }
      },
      messages: {
        "username": {
          required: "Your name is required",
          usernameRegex: "Please enter your full name"
        },
        "email": {
          required: "Your email is required",
          emailRegex: "Please enter a Berkeley, Dartmouth or NYU email",
          remote: "That email is already in use."
        }
      },
    
      errorClass: 'text-error',
      validClass: 'text-success',

      // shows for any error
      showErrors: function(errorMap, errorList){
        this.defaultShowErrors();
        if (errorList.length < 1){
          $('label.error').remove();
          return;
        }
        $.each(errorList, function(index, error){
          $(error.element).parent().parent().attr('class', 'control-group error');
        });
      },

      // changes form to green on success
      success: function(label){
        label.parent().parent().attr('class', 'control-group success');
      }
    });
  </script>

  {% endif %}
{% endblock %}
