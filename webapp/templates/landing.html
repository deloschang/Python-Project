{# NLU LANDING PAGE #}
{# This is the first page that the non-logged-in user sees #}
{# Authentication is handled in views.index #}

{% extends 'base.html' %}

{% block header %}
{% endblock %}

{# Funnel NLU to Registration system #}

{% block content %}
  {% if not user.is_authenticated %}
    {# User is not authenticated #}
      {# Show registration page #}

    <!-- {% if form.errors %}
      <p class="errors">Please correct the errors below: {{ form.non_field_errors }}</p>
    {% endif %} -->

<div id="landing_wrapper">
  <div id="header_wrapper">
    <span id="landing_logo">	
      <a href="/" title="Memeja!"><img src="{{ STATIC_URL }}images/intro_logo.gif" /></a>
    </span>
    <div id="landing_header_container">
      <div id="prop_text_container">  
        {# Value Proposition Line #} 
          The best way to share experiences
        <div id="video_container">
          <a class="fancybox-media" href="http://vimeo.com/50658061">Watch how</a>
        </div>
      </div>
    </div>
    <div id="registration_container">

      {% if form.errors %}
        <p class="errors">Please correct the errors below: {{ form.non_field_errors }}</p>
      {% endif %}
      
      {# For invited users #}
      {% if invitation_key %}
        <h4>
          <div>{{ invitee_object.from_user }} invited you to share in the experience: "{{ invitee_object.from_user_album }}"</div>
        </h4>
      {% endif %}
      
      <form method="post" action="" id="registrationForm" class="wide">
      {% csrf_token %}

        <p>
          <!--<label for="id_username">Full Name:</label>-->
          {% if form.username.errors %}
            <p class="errors">{{ form.username.errors.as_text }}</p>
          {% endif %}
          <div class="control-group">
            <div class="controls">
              {{ form.username }}
            </div>
          </div>
        </p>

        {# Use prefilled email for registration #}
        {% if not invitee_object.to_user_email %}
          <p>
            <!--<label for="id_email">Email:</label>-->
            {% if form.email.errors %}
            <p class="errors">{{ form.email.errors.as_text }}</p>
            {% endif %}
            <div class="control-group">
              <div class="controls">
                {{ form.email }}
              </div>
            </div>
          </p>
        {% else %}
          <label for="id_email">{{ invitee_object.to_user_email }} </label>
          {% if form.email.errors %}
            <p class="errors">{{ form.email.errors.as_text }}</p>
          {% endif %}
        {% endif %}
        {# end #}

        <p>
          {% if form.password1.errors %}
            <p class="errors">{{ form.password1.errors.as_text }}</p>
          {% endif %}

          <div class="control-group">
            <div class="controls">
              {{ form.password1 }}
            </div>
          </div>
        </p>
        {% comment %}
        <p>
        <label for="id_password2">Password (type again to catch typos):</label>
        {% if form.password2.errors %}
          <p class="errors">{{ form.password2.errors.as_text }}</p>
        {% endif %}
        {{ form.password2 }}
        </p>
        {% endcomment %}
        <p class="submit"><input type="submit" class="btn btn-primary" value="Join Memeja"></p>
      </form>
    </div>
    
    {# Video for NLU to watch #}
  </div>
</div>

<div id="footer_wrapper">
  <div id="footer_text">
    Memeja lets you recreate stories with friends:
  </div>

  <div id="footer_prop_container1">
    <div id="share_story">
      <div id="value_pic1">
        <img src="{{ STATIC_URL }}images/share_experiences2.png" />
      </div>
      <div id="value_text1">
        <h3>Share every story easily</h3>
        Tired of writing your stories? Memeja helps you tell stories with memes.
      </div>
    </div>

    <div id="exclusively_private">
      <div id="value_pic2">
        <img src="{{ STATIC_URL }}images/exclusively_private.png" />
      </div>
      <div id="value_text2">
        <h3>Exclusively Private</h3>
        Only the friends <b>you</b> invite can see your stories
      </div>
    </div>

    <div id="recreate_experiences">
      <div id="value_pic3">
        <img src="{{ STATIC_URL }}images/recreate_together.png" />
      </div>
      <div id="value_text3">
        <h3>Recreate experiences together</h3>
        Read your friend's stories, add your perspective, continue the storyline.
      </div>
    </div>
  </div>
</div>


  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.validate.js"></script>
  <script type="text/javascript" src="{{ STATIC_URL}}js/jquery.fancybox.pack.js?v=2.1.3"></script>
  <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.fancybox-media.js"></script>
  <script>
  $(document).ready(function() {
    $('.fancybox-media').fancybox({
      openEffect  : 'none',
      closeEffect : 'none',
      helpers : {
        media : {}
      }
    });
  });

  // csrf passed for AJAX 
  $.ajaxSetup({ 
       beforeSend: function(xhr, settings) {
           function getCookie(name) {
               var cookieValue = null;
               if (document.cookie && document.cookie != '') {
                   var cookies = document.cookie.split(';');
                   for (var i = 0; i < cookies.length; i++) {
                       var cookie = jQuery.trim(cookies[i]);
                       // Does this cookie string begin with the name we want?
                   if (cookie.substring(0, name.length + 1) == (name + '=')) {
                       cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                       break;
                   }
               }
           }
           return cookieValue;
           }
           if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
               // Only send the token to relative URLs i.e. locally.
               xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
           }
       } 
  });
    $.validator.addMethod("usernameRegex", function(value, element){
      return this.optional(element) || /^[A-Za-z0-9._%-]+\s[A-Za-z0-9._%-]+$/i.test(value);
    }, "Please enter your full name");

    $.validator.addMethod("emailRegex", function(value, element){
      return this.optional(element) || /^[A-Za-z0-9._%-]+@(dartmouth|berkeley|nyu)\.edu$/i.test(value);
    }, "Please enter a Berkeley, Dartmouth or NYU email");

    $('#registrationForm').validate({
      rules: {
        "username": {
          required: true,
          usernameRegex: true,
        },
        "email": {
          emailRegex: true,
          remote: {
            url: "/validate/email_duplicates/",
            type: "post",
            data: { 
              response: function(){
                return $('#email').val();
              }
            }
          }
        }
      },
      messages: {
        "username": {
          required: "Your name is required",
          usernameRegex: "Please enter your full name"
        },
        "email": {
          required: "Your email is required",
          emailRegex: "Please enter a Berkeley, Dartmouth or NYU email",
          remote: "That email is already in use."
        }
      },
    
      errorClass: 'text-error',
      validClass: 'text-success',

      // shows for any error
      showErrors: function(errorMap, errorList){
        this.defaultShowErrors();
        if (errorList.length < 1){
          $('label.error').remove();
          return;
        }
        $.each(errorList, function(index, error){
          $(error.element).parent().parent().attr('class', 'control-group error');
        });
      },

      // changes form to green on success
      success: function(label){
        label.parent().parent().attr('class', 'control-group success');
      }
    });
  </script>

  {% endif %}
{% endblock %}
